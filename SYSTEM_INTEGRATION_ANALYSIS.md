# ๐ ุชุญููู ููุงุท ุงูุชูุงูู - ูุธุงู ุจูุฏูุฉ ุชูุฑูุช

## ๐ ุชุงุฑูุฎ ุงูุชุญููู: 2025-01-XX

---

## ๐ 1. ุงูุจููุฉ ุงูุญุงููุฉ ูููุธุงู

### 1.1 ูููู ุงููุฌูุฏุงุช
```
tekrit_municipality/
โโโ config/
โ   โโโ database.php          โ ููุฌูุฏ
โโโ includes/
โ   โโโ auth.php              โ ููุฌูุฏ (ูุณุชุฎุฏู $_SESSION ูุจุงุดุฑุฉ)
โ   โโโ Utils.php             โ ููุฌูุฏ (ูุญุชูู ุนูู CSRF ู Validation ุฌุฒุฆู)
โ   โโโ Database.php          โ ููุฌูุฏ
โ   โโโ [ูููุงุช ุฃุฎุฑู]
โโโ modules/
โ   โโโ facilities_api.php    โ ููุฌูุฏ (CORS ููุชูุญ: *)
โ   โโโ [ูููุงุช ุฃุฎุฑู]
โโโ api/
โ   โโโ finance.php           โ ููุฌูุฏ
โ   โโโ financial_transactions.php โ ููุฌูุฏ
โโโ public/
    โโโ citizen-requests.php  โ ููุฌูุฏ (ูุง ูุณุชุฎุฏู CSRF ุญุงููุงู)
```

---

## โ๏ธ 2. ููุงุท ุงูุชูุงูู ูุงูุชุญุฐูุฑุงุช

### 2.1 ูุธุงู Authentication ุงูุญุงูู

**ุงูููู:** `includes/auth.php`

**ุงููุถุน ุงูุญุงูู:**
- โ ูุณุชุฎุฏู `session_start()` ูุจุงุดุฑุฉ
- โ ูุณุชุฎุฏู `$_SESSION` ูุจุงุดุฑุฉ
- โ ูุญุชูู ุนูู `login()`, `logout()`, `isLoggedIn()`, `requireLogin()`
- โ ูุญุชูู ุนูู `getUserInfo()` ู `checkPermission()`
- โ๏ธ **ูุง ููุฌุฏ Session Security ูุญุณูู**
- โ๏ธ **ูุง ููุฌุฏ Login Attempts Tracking**

**ููุงุท ุงูุชูุงูู:**
1. **SessionManager.php** - ูููู ุงุณุชุจุฏุงู `session_start()` ุชุฏุฑูุฌูุงู
2. **Login Attempts** - ูุญุชุงุฌ ุฌุฏูู `login_attempts` ุฌุฏูุฏ
3. **Session Timeout** - ูููู ุฅุถุงูุชู ุจุฏูู ูุณุฑ ุงูููุฏ ุงูุญุงูู

**ุงูุชูุตูุฉ:** โ **ุขูู ููุชูุงูู** - ูููู ุฅุถุงูุฉ SessionManager ูุทุจูุฉ ุฅุถุงููุฉ

---

### 2.2 ูุธุงู API ุงูุญุงูู

**ุงููููุงุช:**
- `modules/facilities_api.php` (ุงูุฑุฆูุณู)
- `api/finance.php`
- `api/financial_transactions.php`

**ุงููุถุน ุงูุญุงูู:**
```php
// facilities_api.php
header('Access-Control-Allow-Origin: *');  // โ ููุชูุญ ููุฌููุน
header('Access-Control-Allow-Methods: GET, POST');
header('Access-Control-Allow-Headers: Content-Type');
```

**ุงููุดุงูู:**
- โ CORS ููุชูุญ ููุฌููุน (`*`)
- โ ูุง ููุฌุฏ API Key Authentication
- โ ูุง ููุฌุฏ Rate Limiting
- โ ูุง ููุฌุฏ Input Validation ุดุงูู
- โ๏ธ ูุนุฑุถ `debug_info` ูู ุงูุฃุฎุทุงุก (ูุนูููุงุช ุญุณุงุณุฉ)

**ููุงุท ุงูุชูุงูู:**
1. **ApiSecurity.php** - ูููู ุฅุถุงูุชู ูู ุจุฏุงูุฉ ุงูููู
2. **Validator.php** - ูููู ุงุณุชุฎุฏุงูู ูุชูุธูู ุงููุฏุฎูุงุช
3. **ErrorHandler.php** - ูููู ุงุณุชุจุฏุงู `catch` ุงูุญุงูู

**ุงูุชูุตูุฉ:** โ๏ธ **ูุญุชุงุฌ ุญุฐุฑ** - ุงูุชุบููุฑุงุช ูุฏ ุชุคุซุฑ ุนูู ุงูุชุทุจููุงุช ุงูุฎุงุฑุฌูุฉ

---

### 2.3 ูุธุงู Validation ุงูุญุงูู

**ุงูููู:** `includes/Utils.php`

**ุงููุถุน ุงูุญุงูู:**
- โ ูุญุชูู ุนูู `sanitizeInput()`
- โ ูุญุชูู ุนูู `validateEmail()`
- โ ูุญุชูู ุนูู `validateIraqiPhone()` (ููู ุงููุธุงู ูุจูุงูู!)
- โ ูุญุชูู ุนูู `validateIraqiNationalId()` (ููู ุงููุธุงู ูุจูุงูู!)
- โ ูุญุชูู ุนูู `generateCSRFToken()` ู `validateCSRFToken()`
- โ๏ธ **CSRF ููุฌูุฏ ููู ุบูุฑ ูุณุชุฎุฏู ูู ุฌููุน ุงูููุงุฐุฌ**

**ููุงุท ุงูุชูุงูู:**
1. **Validator.php** - ูููู ุงุณุชุจุฏุงู ุฃู ุชูุณูุน Utils.php
2. **CSRF Protection** - ูุญุชุงุฌ ุฅุถุงูุฉ ุญููู ูุฌููุน ุงูููุงุฐุฌ

**ุงูุชูุตูุฉ:** โ **ุขูู ููุชูุงูู** - ูููู ุชูุณูุน Utils.php ุฃู ุฅูุดุงุก Validator.php ุฌุฏูุฏ

---

### 2.4 ูุธุงู Error Handling ุงูุญุงูู

**ุงููุถุน ุงูุญุงูู:**
- โ๏ธ ูุนุธู ุงููููุงุช ุชุณุชุฎุฏู `try-catch` ุจุณูุท
- โ๏ธ ูุนุฑุถ ุฑุณุงุฆู ุฎุทุฃ ูุจุงุดุฑุฉ ูููุณุชุฎุฏู
- โ๏ธ ูุนุฑุถ `debug_info` ูู API responses
- โ๏ธ ูุง ููุฌุฏ ูุธุงู Logging ูุฑูุฒู

**ูุซุงู ูู `facilities_api.php`:**
```php
catch (Exception $e) {
    $response['success'] = false;
    $response['error'] = $e->getMessage();  // โ ูุดู ุชูุงุตูู ุงูุฎุทุฃ
    $response['debug_info'] = [...];        // โ ูุนูููุงุช ุญุณุงุณุฉ
}
```

**ููุงุท ุงูุชูุงูู:**
1. **ErrorHandler.php** - ูููู ุงุณุชุจุฏุงู ุฌููุน `catch` ุชุฏุฑูุฌูุงู
2. **Logger.php** - ูููู ุฅุถุงูุชู ุจุฏูู ูุณุฑ ุงูููุฏ ุงูุญุงูู

**ุงูุชูุตูุฉ:** โ **ุขูู ููุชูุงูู** - ูููู ุฅุถุงูุฉ ErrorHandler ู Logger ุชุฏุฑูุฌูุงู

---

### 2.5 ูุธุงู Forms ุงูุญุงูู

**ุงููููุงุช:**
- `public/citizen-requests.php`
- `public/citizen-requests-advanced.php`
- ุฌููุน ุงูููุงุฐุฌ ูู `modules/`

**ุงููุถุน ุงูุญุงูู:**
- โ๏ธ **ูุง ูุณุชุฎุฏู CSRF Protection** ูู ูุนุธู ุงูููุงุฐุฌ
- โ๏ธ **ูุง ููุฌุฏ Input Validation ุดุงูู**
- โ ูุณุชุฎุฏู `Utils::sanitizeInput()` ูู ุจุนุถ ุงูุฃูุงูู
- โ ูุณุชุฎุฏู reCAPTCHA ูู ุจุนุถ ุงูููุงุฐุฌ

**ููุงุท ุงูุชูุงูู:**
1. **CSRF Protection** - ูุญุชุงุฌ ุฅุถุงูุฉ `<input type="hidden" name="csrf_token">` ูุฌููุน ุงูููุงุฐุฌ
2. **Validator.php** - ูููู ุงุณุชุฎุฏุงูู ูุชุญุณูู Validation

**ุงูุชูุตูุฉ:** โ๏ธ **ูุญุชุงุฌ ุญุฐุฑ** - ุฅุถุงูุฉ CSRF ูุฏ ููุณุฑ ุงูููุงุฐุฌ ุงูููุฌูุฏุฉ

---

## ๐ 3. ุฎุทุฉ ุงูุชูุงูู ุงูุขููุฉ

### ุงููุฑุญูุฉ 1: ุฅุถุงูุฉ ุงูุฃูุธูุฉ ุงูุฃุณุงุณูุฉ (ุขููุฉ 100%)

#### 1.1 ErrorHandler.php + Logger.php
- โ **ูุง ููุณุฑ ุฃู ุดูุก**
- โ ูููู ุฅุถุงูุชู ุชุฏุฑูุฌูุงู
- โ ูููู ุงุณุชุฎุฏุงูู ูู ูููุงุช ุฌุฏูุฏุฉ ุฃููุงู

**ุงููููุงุช ุงููุชุฃุซุฑุฉ:** ูุง ุดูุก (ุฅุถุงูุฉ ุฌุฏูุฏุฉ)

---

#### 1.2 Validator.php (ูุทุจูุฉ ุฅุถุงููุฉ)
- โ **ูุง ููุณุฑ ุฃู ุดูุก**
- โ ูููู ุงุณุชุฎุฏุงูู ุจุฌุงูุจ Utils.php
- โ ูููู ุงุณุชุจุฏุงู Utils.php ุชุฏุฑูุฌูุงู

**ุงููููุงุช ุงููุชุฃุซุฑุฉ:** ูุง ุดูุก (ุฅุถุงูุฉ ุฌุฏูุฏุฉ)

---

### ุงููุฑุญูุฉ 2: ุชุญุณูู ุงูุฃูุธูุฉ ุงูููุฌูุฏุฉ (ุขููุฉ 90%)

#### 2.1 SessionManager.php
- โ **ุขูู** - ูููู ุฅุถุงูุชู ูุทุจูุฉ ููู `$_SESSION`
- โ๏ธ ูุญุชุงุฌ ุชุญุฏูุซ `includes/auth.php` ุชุฏุฑูุฌูุงู
- โ๏ธ ูุญุชุงุฌ ุงุฎุชุจุงุฑ ุดุงูู

**ุงููููุงุช ุงููุชุฃุซุฑุฉ:**
- `includes/auth.php` (ุชุญุฏูุซ ุชุฏุฑูุฌู)
- ุฌููุน ุงููููุงุช ุงูุชู ุชุณุชุฎุฏู `$_SESSION` ูุจุงุดุฑุฉ

**ุงูุชูุตูุฉ:** โ **ุขูู** - ูููู ุงูุจุฏุก ุจู

---

#### 2.2 Cache.php
- โ **ูุง ููุณุฑ ุฃู ุดูุก**
- โ ูููู ุฅุถุงูุชู ุชุฏุฑูุฌูุงู
- โ ูููู ุงุณุชุฎุฏุงูู ูู API ุฃููุงู

**ุงููููุงุช ุงููุชุฃุซุฑุฉ:** ูุง ุดูุก (ุฅุถุงูุฉ ุฌุฏูุฏุฉ)

---

### ุงููุฑุญูุฉ 3: ุชุฃููู API (ูุญุชุงุฌ ุญุฐุฑ)

#### 3.1 ApiSecurity.php
- โ๏ธ **ูุฏ ููุณุฑ ุงูุชุทุจููุงุช ุงูุฎุงุฑุฌูุฉ**
- โ๏ธ ูุญุชุงุฌ ุชุญุฏูุซ ุฌููุน API endpoints
- โ๏ธ ูุญุชุงุฌ ุฅุดุนุงุฑ ุงููุทูุฑูู ุงูุฎุงุฑุฌููู

**ุงููููุงุช ุงููุชุฃุซุฑุฉ:**
- `modules/facilities_api.php`
- `api/finance.php`
- `api/financial_transactions.php`
- ุฃู ุชุทุจููุงุช ุฎุงุฑุฌูุฉ ุชุณุชุฎุฏู API

**ุงูุชูุตูุฉ:** โ๏ธ **ูุญุชุงุฌ ุฎุทุฉ ุชุฏุฑูุฌูุฉ:**
1. ุฅุถุงูุฉ API Keys ูู optional ุฃููุงู
2. ุฅุดุนุงุฑ ุงููุทูุฑูู
3. ุฌุนู API Keys required ุจุนุฏ ูุชุฑุฉ

---

#### 3.2 CORS Security
- โ๏ธ **ูุฏ ููุณุฑ ุงูุชุทุจููุงุช ุงูุฎุงุฑุฌูุฉ**
- โ๏ธ ูุญุชุงุฌ ูุนุฑูุฉ ุฌููุน ุงููุทุงูุงุช ุงููุณููุญุฉ

**ุงูุชูุตูุฉ:** โ๏ธ **ูุญุชุงุฌ ุฎุทุฉ ุชุฏุฑูุฌูุฉ:**
1. ุฅุถุงูุฉ ุงููุทุงูุงุช ุงููุณููุญุฉ ุชุฏุฑูุฌูุงู
2. ุงูุงุญุชูุงุธ ุจู `*` ูู fallback ูุคูุช
3. ุฅุฒุงูุฉ `*` ุจุนุฏ ุงูุชุฃูุฏ

---

### ุงููุฑุญูุฉ 4: CSRF Protection (ูุญุชุงุฌ ุญุฐุฑ)

#### 4.1 ุฅุถุงูุฉ CSRF ููููุงุฐุฌ
- โ๏ธ **ูุฏ ููุณุฑ ุงูููุงุฐุฌ ุงูููุฌูุฏุฉ**
- โ๏ธ ูุญุชุงุฌ ุฅุถุงูุฉ ุญููู ูุฌููุน ุงูููุงุฐุฌ
- โ๏ธ ูุญุชุงุฌ ุชุญุฏูุซ ุฌููุน ูุนุงูุฌุงุช ุงูููุงุฐุฌ

**ุงููููุงุช ุงููุชุฃุซุฑุฉ:**
- ุฌููุน ูููุงุช `modules/` ุงูุชู ุชุญุชูู ุนูู forms
- `public/citizen-requests.php`
- ุฃู ูููุงุช ุฃุฎุฑู ุชุญุชูู ุนูู forms

**ุงูุชูุตูุฉ:** โ๏ธ **ูุญุชุงุฌ ุฎุทุฉ ุชุฏุฑูุฌูุฉ:**
1. ุฅุถุงูุฉ CSRF ููููุงุฐุฌ ุงูุฌุฏูุฏุฉ ุฃููุงู
2. ุชุญุฏูุซ ุงูููุงุฐุฌ ุงููุฏููุฉ ุชุฏุฑูุฌูุงู
3. ุงุฎุชุจุงุฑ ุดุงูู ููู ูููุฐุฌ

---

## ๐ฏ 4. ุงูุชูุตูุงุช ุงูููุงุฆูุฉ

### โ ุขูู ููุจุฏุก ููุฑุงู:
1. **ErrorHandler.php** + **Logger.php**
2. **Validator.php** (ูุทุจูุฉ ุฅุถุงููุฉ)
3. **Cache.php**

### โ๏ธ ูุญุชุงุฌ ุฎุทุฉ ุชุฏุฑูุฌูุฉ:
1. **SessionManager.php** (ุชุญุฏูุซ auth.php ุชุฏุฑูุฌูุงู)
2. **ApiSecurity.php** (ุฌุนู API Keys optional ุฃููุงู)
3. **CSRF Protection** (ุฅุถุงูุฉ ููููุงุฐุฌ ุงูุฌุฏูุฏุฉ ุฃููุงู)

### โ ูุญุชุงุฌ ุฏุฑุงุณุฉ ุฃุนูู:
1. **Full-Text Search** (ุงูุชุญูู ูู ุฏุนู ุงูุฌุฏุงูู)
2. **ุฅุนุงุฏุฉ ููููุฉ ุงููุฌูุฏุงุช** (ูุฏ ููุณุฑ paths)

---

## ๐ 5. ุฎุทุฉ ุงูุชูููุฐ ุงูููุชุฑุญุฉ

### ุงูุฃุณุจูุน 1: ุงูุฃูุธูุฉ ุงูุฃุณุงุณูุฉ (ุขููุฉ 100%)
- [ ] ุฅูุดุงุก `includes/ErrorHandler.php`
- [ ] ุฅูุดุงุก `includes/Logger.php`
- [ ] ุฅูุดุงุก `includes/Validator.php` (ูุทุจูุฉ ุฅุถุงููุฉ)
- [ ] ุฅูุดุงุก `includes/Cache.php`
- [ ] ุงุฎุชุจุงุฑ ุฌููุน ุงูุฃูุธูุฉ ุงูุฌุฏูุฏุฉ

### ุงูุฃุณุจูุน 2: ุชุญุณูู Authentication (ุขููุฉ 90%)
- [ ] ุฅูุดุงุก `includes/SessionManager.php`
- [ ] ุชุญุฏูุซ `includes/auth.php` ูุงุณุชุฎุฏุงู SessionManager
- [ ] ุฅุถุงูุฉ Login Attempts Tracking
- [ ] ุงุฎุชุจุงุฑ ุดุงูู

### ุงูุฃุณุจูุน 3: ุชุฃููู API (ูุญุชุงุฌ ุญุฐุฑ)
- [ ] ุฅูุดุงุก `includes/ApiSecurity.php`
- [ ] ุฅูุดุงุก `config/api_config.php` (ูุน API Keys ูู ููู ูููุตู)
- [ ] ุชุญุฏูุซ `modules/facilities_api.php` (ุฌุนู API Keys optional)
- [ ] ุงุฎุชุจุงุฑ API ูุน/ุจุฏูู API Keys
- [ ] ุฅุดุนุงุฑ ุงููุทูุฑูู ุงูุฎุงุฑุฌููู

### ุงูุฃุณุจูุน 4: CSRF Protection (ูุญุชุงุฌ ุญุฐุฑ)
- [ ] ุชุญุฏูุซ `includes/CsrfProtection.php` (ุฃู ุงุณุชุฎุฏุงู Utils.php ุงูููุฌูุฏ)
- [ ] ุฅุถุงูุฉ CSRF ููููุงุฐุฌ ุงูุฌุฏูุฏุฉ
- [ ] ุชุญุฏูุซ ุงูููุงุฐุฌ ุงููุฏููุฉ ุชุฏุฑูุฌูุงู
- [ ] ุงุฎุชุจุงุฑ ุดุงูู

---

## โ๏ธ 6. ุงูุชุญุฐูุฑุงุช ุงููููุฉ

### 6.1 API Keys
**ุงููุดููุฉ ูู ุงูุฎุทุฉ ุงูุฃุตููุฉ:**
```php
'api_keys' => [
    'public_key' => 'TKT_PUBLIC_' . bin2hex(random_bytes(16)), // โ ูุชุบูุฑ!
]
```

**ุงูุญู ุงูููุชุฑุญ:**
- ุญูุธ API Keys ูู ููู `.env` ุฃู ูุงุนุฏุฉ ุจูุงูุงุช
- ุฃู ูู ููู `config/api_keys.php` (ุบูุฑ versioned)

### 6.2 Session Security
**ุงููุดููุฉ ูู ุงูุฎุทุฉ ุงูุฃุตููุฉ:**
```php
ini_set('session.cookie_secure', 1); // โ ุณูุนุทู localhost
```

**ุงูุญู ุงูููุชุฑุญ:**
```php
ini_set('session.cookie_secure', isset($_SERVER['HTTPS']) ? 1 : 0);
```

### 6.3 Full-Text Search
**ุงูุชุญุฐูุฑ:**
- ูุชุทูุจ FULLTEXT index
- ูุฏ ูุง ูุนูู ุนูู ุฌููุน ุงูุฌุฏุงูู
- ูุญุชุงุฌ ุงูุชุญูู ูู ููุน ูุญุฑู ุงูุฌุฏุงูู

---

## โ 7. ุงูุฎูุงุตุฉ

### ุงููุธุงู ุงูุญุงูู:
- โ **ุฌูุฏ** - ูุญุชูู ุนูู ุฃุณุงุณูุงุช (Utils.php, auth.php)
- โ๏ธ **ูุญุชุงุฌ ุชุญุณูู** - ุงูุฃูุงู ูุงูุฃุฏุงุก
- โ๏ธ **ูุญุชุงุฌ ุชูุธูู** - ุจุนุถ ุงููููุงุช ุงูููุฑุฑุฉ

### ุฎุทุฉ ุงูุชุญุณูู:
- โ **ูุงุจูุฉ ููุชูููุฐ** - ูุน ุงูุชุนุฏููุงุช ุงูููุชุฑุญุฉ
- โ๏ธ **ูุญุชุงุฌ ุชูููุฐ ุชุฏุฑูุฌู** - ูุชุฌูุจ ูุณุฑ ุงููุธุงู
- โ **ุขููุฉ ููุจุฏุก** - ุจุงููุฑุญูุฉ 1 (ErrorHandler, Logger, Validator, Cache)

### ุงูุชูุตูุฉ ุงูููุงุฆูุฉ:
**ุงุจุฏุฃ ุจุงููุฑุญูุฉ 1** (ErrorHandler + Logger + Validator + Cache) ูุฃููุง:
- โ ูุง ุชูุณุฑ ุฃู ุดูุก
- โ ุชุถูู ูููุฉ ููุฑูุฉ
- โ ุชููู ูู ุงููุฑุงุญู ุงูุชุงููุฉ

---

**ุชุงุฑูุฎ ุงูุชุญููู:** 2025-01-XX  
**ุงูุชุญููู ุจูุงุณุทุฉ:** Cursor AI Assistant


