# ๐ ููุฎุต ุชุญุฏูุซุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช

## ๐๏ธ ุจูุฏูุฉ ุชูุฑูุช - ุนูุงุฑุ ุดูุงู ูุจูุงู

**ุงูุชุงุฑูุฎ:** 2025-11-10  
**ุงููุฑุญูุฉ:** 2 - ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุชูููุฐ

---

## ๐ฆ ุงููููุงุช ุงููููุดุฃุฉ

### 1. ูููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช

| ุงูููู | ุงููุตู | ุงูุญุฌู |
|-------|-------|-------|
| `database/citizen_accounts_system.sql` | ุงูุณูุฑูุจุช ุงููุงูู ูุฅูุดุงุก ุงูุฌุฏุงูู | ~15 KB |
| `database/test_queries.sql` | ุงุฎุชุจุงุฑุงุช ุดุงููุฉ ูููุธุงู | ~12 KB |
| `database/DATABASE_SCHEMA_DIAGRAM.md` | ูุฎุทุทุงุช ุจุตุฑูุฉ ููุนูุงูุงุช | ~8 KB |

### 2. ูููุงุช ุงูุชุซุจูุช ูุงูุชูุซูู

| ุงูููู | ุงููุตู | ุงูุญุฌู |
|-------|-------|-------|
| `setup_citizen_accounts_system.php` | ุตูุญุฉ ุงูุชุซุจูุช ุงูุชูุงุนููุฉ | ~8 KB |
| `CITIZEN_ACCOUNTS_DATABASE_DOCUMENTATION.md` | ุงูุชูุซูู ุงููุงูู | ~18 KB |
| `CITIZEN_ACCOUNTS_SETUP_README.md` | ุฏููู ุงูุชุซุจูุช ุงูุณุฑูุน | ~3 KB |
| `DATABASE_UPDATE_SUMMARY.md` | ูุฐุง ุงูููู | ~2 KB |

---

## ๐๏ธ ุงูุฌุฏุงูู ุงููููุดุฃุฉ (6 ุฌุฏุงูู)

### 1. `citizens_accounts` - ุญุณุงุจุงุช ุงูููุงุทููู
- **ุงูุฃุนูุฏุฉ:** 12
- **ุงูููุงุฑุณ:** 4
- **ุงููุตู:** ูุนูููุงุช ุงูููุงุทููู ุงูุฃุณุงุณูุฉ

### 2. `magic_links` - ุฑูุงุจุท ุงูุฏุฎูู ุงูุณุญุฑูุฉ
- **ุงูุฃุนูุฏุฉ:** 10
- **ุงูููุงุฑุณ:** 5
- **ุงูุนูุงูุงุช:** 1 (ูุน `citizens_accounts`)
- **ุงููุตู:** ุฑูุงุจุท ูุฑูุฏุฉ ููุฏุฎูู ุงูุณุฑูุน

### 3. `citizen_messages` - ุฑุณุงุฆู ุงูุจูุฏูุฉ
- **ุงูุฃุนูุฏุฉ:** 13
- **ุงูููุงุฑุณ:** 7
- **ุงูุนูุงูุงุช:** 3 (ูุน `citizens_accounts`, `citizen_requests`, `users`)
- **ุงููุตู:** ุฑุณุงุฆู ูุฅุดุนุงุฑุงุช ูู ุงูุจูุฏูุฉ

### 4. `whatsapp_log` - ุณุฌู WhatsApp
- **ุงูุฃุนูุฏุฉ:** 12
- **ุงูููุงุฑุณ:** 6
- **ุงูุนูุงูุงุช:** 2 (ูุน `citizens_accounts`, `citizen_requests`)
- **ุงููุตู:** ุณุฌู ูุงูู ูุฑุณุงุฆู WhatsApp

### 5. `notification_preferences` - ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช
- **ุงูุฃุนูุฏุฉ:** 9
- **ุงูููุงุฑุณ:** 1
- **ุงูุนูุงูุงุช:** 1 (ูุน `citizens_accounts`)
- **ุงููุตู:** ุชูุถููุงุช ุงูููุงุทู ููุฅุดุนุงุฑุงุช

### 6. `citizen_sessions` - ุฌูุณุงุช ุงูููุงุทููู
- **ุงูุฃุนูุฏุฉ:** 8
- **ุงูููุงุฑุณ:** 4
- **ุงูุนูุงูุงุช:** 1 (ูุน `citizens_accounts`)
- **ุงููุตู:** ุฌูุณุงุช ุชุณุฌูู ุงูุฏุฎูู ุงููุดุทุฉ

---

## ๐๏ธ Views ุงููููุดุฃุฉ (3)

### 1. `v_citizens_summary`
ููุฎุต ุดุงูู ููู ููุงุทู ูุน ุฅุญุตุงุฆูุงุชู (ุงูุทูุจุงุชุ ุงูุฑุณุงุฆูุ ุฅูุฎ)

### 2. `v_citizen_messages_detailed`
ุฑุณุงุฆู ุงูููุงุทููู ูุน ุชูุงุตูู ูุงููุฉ (ุงุณู ุงูููุงุทูุ ุงููุฑุณูุ ุงูุทูุจ)

### 3. `v_whatsapp_log_detailed`
ุณุฌู WhatsApp ูุน ุชูุงุตูู ุงูููุงุทู ูุงูุทูุจ

---

## ๐ง Stored Procedures ุงููููุดุฃุฉ (3)

### 1. `sp_get_or_create_citizen_account`
ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ ุฃู ุฌูุจ ุงูุญุณุงุจ ุงูููุฌูุฏ

### 2. `sp_cleanup_expired_links`
ุชูุธูู ุงูุฑูุงุจุท ูุงูุฌูุณุงุช ุงูููุชููุฉ (ููุชุดุบูู ุงููููู)

### 3. `sp_get_citizen_stats`
ุฅุญุตุงุฆูุงุช ุชูุตูููุฉ ูููุงุทู ูุนูู

---

## โก Triggers ุงููููุดุฃุฉ (2)

### 1. `tr_update_login_count`
ุชุญุฏูุซ `last_login` ู `login_count` ุนูุฏ ุฅูุดุงุก ุฌูุณุฉ ุฌุฏูุฏุฉ

### 2. `tr_log_citizen_message`
ุชุณุฌูู ุชููุงุฆู ูู `whatsapp_log` ุนูุฏ ุฅูุดุงุก ุฑุณุงูุฉ

---

## โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงูููุถุงูุฉ (10)

ุชู ุฅุถุงูุฉ ุฅุนุฏุงุฏุงุช WhatsApp ูู ุฌุฏูู `website_settings`:

1. `whatsapp_enabled` - ุชูุนูู/ุชุนุทูู
2. `whatsapp_business_number` - ุฑูู WhatsApp
3. `whatsapp_api_method` - ุทุฑููุฉ ุงูุฅุฑุณุงู
4. `whatsapp_welcome_template` - ูุงูุจ ุงูุชุฑุญูุจ
5. `whatsapp_status_update_template` - ูุงูุจ ุงูุชุญุฏูุซ
6. `whatsapp_completion_template` - ูุงูุจ ุงูุฅูุฌุงุฒ
7. `whatsapp_reminder_template` - ูุงูุจ ุงูุชุฐููุฑ
8. `whatsapp_general_message_template` - ูุงูุจ ุนุงู
9. `municipality_phone` - ุฑูู ุงูุจูุฏูุฉ
10. `municipality_whatsapp_name` - ุงุณู ุญุณุงุจ WhatsApp

---

## ๐ ุฎุทูุงุช ุงูุชุซุจูุช

### ุงูุทุฑููุฉ ุงูููุตู ุจูุง (ุนุจุฑ ุงููุงุฌูุฉ):

```
1. ุงูุชุญ: http://localhost:8080/tekrit_municipality/setup_citizen_accounts_system.php
2. ุงุชุจุน ุงูุชุนูููุงุช ุนูู ุงูุดุงุดุฉ
3. ุชุญูู ูู ุงููุฌุงุญ
```

### ุงูุทุฑููุฉ ุงูุจุฏููุฉ (ุนุจุฑ phpMyAdmin):

```sql
1. ุงูุชุญ phpMyAdmin
2. ุงุฎุชุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช tekrit_municipality
3. ุงุณุชูุฑุฏ ููู: database/citizen_accounts_system.sql
```

### ุงูุทุฑููุฉ ุงููุฏููุฉ (ุณุทุฑ ุงูุฃูุงูุฑ):

```bash
mysql -u root -p tekrit_municipality < database/citizen_accounts_system.sql
```

---

## โ ุงูุงุฎุชุจุงุฑุงุช

ูุงุฎุชุจุงุฑ ุงููุธุงู ุจุงููุงููุ ูู ุจุชุดุบูู:

```sql
SOURCE database/test_queries.sql;
```

ูุฐุง ุงูุณูุฑูุจุช ุณูููู ุจู:
- โ ุงูุชุญูู ูู ูุฌูุฏ ุฌููุน ุงูุฌุฏุงูู
- โ ุงูุชุญูู ูู ุงูุฃุนูุฏุฉ ูุงูููุงุฑุณ
- โ ุงูุชุญูู ูู ุงูุนูุงูุงุช (Foreign Keys)
- โ ุงุฎุชุจุงุฑ Views
- โ ุงุฎุชุจุงุฑ Stored Procedures
- โ ุงุฎุชุจุงุฑ Triggers
- โ ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ ูุงุฎุชุจุงุฑูุง
- โ ุชูุธูู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ
- โ ุนุฑุถ ุฅุญุตุงุฆูุงุช ุนุงูุฉ

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

### ุฅุฌูุงูู ูุง ุชู ุฅูุดุงุคู:
- **6** ุฌุฏุงูู ุฌุฏูุฏุฉ
- **27** ููุฑุณ (Index)
- **8** ุนูุงูุงุช (Foreign Keys)
- **3** Views
- **3** Stored Procedures
- **2** Triggers
- **10** ุฅุนุฏุงุฏุงุช ุฌุฏูุฏุฉ
- **~60** ุนููุฏ ุฌุฏูุฏ

### ุญุฌู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุชููุน:
- **ุตุบูุฑ:** ~1 MB (100 ููุงุทู)
- **ูุชูุณุท:** ~10 MB (1,000 ููุงุทู)
- **ูุจูุฑ:** ~100 MB (10,000 ููุงุทู)

---

## ๐ ุงูุฃูุงู

### ุงูุฅุฌุฑุงุกุงุช ุงููุทุจูุฉ:
- โ Foreign Keys ูุน CASCADE/SET NULL
- โ ููุงุฑุณ ุนูู ุฌููุน ุงูุฃุนูุฏุฉ ุงูุญุณุงุณุฉ
- โ Magic Links ุจุตูุงุญูุฉ ูุญุฏูุฏุฉ
- โ ุงุณุชุฎุฏุงู ููุฑุฉ ูุงุญุฏุฉ ููุฑูุงุจุท
- โ ุชุณุฌูู IP ู User Agent
- โ ุงูุชูุงุก ุชููุงุฆู ููุฌูุณุงุช
- โ ุชุดููุฑ UTF-8 ูุฌููุน ุงูุฌุฏุงูู

---

## ๐งน ุงูุตูุงูุฉ ุงูุฏูุฑูุฉ

### ููููุงู (Cron Job):
```sql
CALL sp_cleanup_expired_links();
```

### ุฃุณุจูุนูุงู:
```sql
ANALYZE TABLE citizens_accounts, magic_links, citizen_messages, whatsapp_log;
```

### ุดูุฑูุงู (ุงุฎุชูุงุฑู):
```sql
-- ุฃุฑุดูุฉ ุงูุฑุณุงุฆู ุงููุฏููุฉ
DELETE FROM citizen_messages 
WHERE is_read = 1 AND created_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);

-- ุฃุฑุดูุฉ ุณุฌู WhatsApp
DELETE FROM whatsapp_log 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);
```

---

## ๐ ูุคุดุฑุงุช ุงูุฃุฏุงุก

### ุงูููุงุฑุณ ุงูููุญุณููุฉ:
- โ ุงูุจุญุซ ุจุงููุงุชู: `O(log n)` ุจุฏูุงู ูู `O(n)`
- โ ุงูุชุญูู ูู Magic Links: `O(1)` ุชูุฑูุจุงู
- โ ุฌูุจ ุฑุณุงุฆู ุงูููุงุทู: `O(log n)`
- โ ููุชุฑุฉ ุญุณุจ ุงูุญุงูุฉ: `O(log n)`

### ุงูุงุณุชุนูุงูุงุช ุงูููุญุณููุฉ:
- โ Views ุฌุงูุฒุฉ ููุชูุงุฑูุฑ
- โ Stored Procedures ููุนูููุงุช ุงููุนูุฏุฉ
- โ Triggers ููุชุญุฏูุซุงุช ุงูุชููุงุฆูุฉ

---

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ

ุจุนุฏ ุชุซุจูุช ูุงุนุฏุฉ ุงูุจูุงูุงุช:

### ุงููุฑุญูุฉ 3: ุฅูุดุงุก ูููุงุช PHP
1. โ `includes/CitizenAccount.php` - ููุงุณ ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช
2. โ `includes/WhatsAppHelper.php` - ูุณุงุนุฏ WhatsApp
3. โ `includes/MagicLink.php` - ุฅุฏุงุฑุฉ ุงูุฑูุงุจุท ุงูุณุญุฑูุฉ
4. โ `public/my-account-login.php` - ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
5. โ `public/my-account.php` - ุงูุตูุญุฉ ุงูุดุฎุตูุฉ
6. โ ุชุญุฏูุซ `public/citizen-requests.php` - ุงูุชุณุฌูู ุงูุชููุงุฆู

### ุงููุฑุญูุฉ 4: ุงููุงุฌูุงุช ุงูุฅุฏุงุฑูุฉ
1. โ `modules/citizens_management.php` - ุฅุฏุงุฑุฉ ุงูููุงุทููู
2. โ `modules/send_whatsapp_messages.php` - ุฅุฑุณุงู ุฑุณุงุฆู WhatsApp
3. โ `modules/whatsapp_log_viewer.php` - ุนุฑุถ ุณุฌู WhatsApp

### ุงููุฑุญูุฉ 5: ุงูุงุฎุชุจุงุฑ ูุงูุชุดุบูู
1. โ ุงุฎุชุจุงุฑ ุงูุชุณุฌูู ุงูุชููุงุฆู
2. โ ุงุฎุชุจุงุฑ Magic Links
3. โ ุงุฎุชุจุงุฑ ุฅุฑุณุงู WhatsApp
4. โ ุงุฎุชุจุงุฑ ุงูุตูุญุฉ ุงูุดุฎุตูุฉ
5. โ ุงูุชุดุบูู ุงูุชุฌุฑูุจู

---

## ๐ ุงูุฏุนู

ูููุณุงุนุฏุฉ ุฃู ุงูุงุณุชูุณุงุฑุงุช:
- ๐ง support@tekrit.gov.lb
- ๐ฑ 06-123-456
- ๐๏ธ ุจูุฏูุฉ ุชูุฑูุช - ุนูุงุฑุ ุดูุงู ูุจูุงู

---

## ๐ ุงููุซุงุฆู

- [ุงูุชูุซูู ุงููุงูู](CITIZEN_ACCOUNTS_DATABASE_DOCUMENTATION.md)
- [ุฏููู ุงูุชุซุจูุช ุงูุณุฑูุน](CITIZEN_ACCOUNTS_SETUP_README.md)
- [ูุฎุทุทุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช](database/DATABASE_SCHEMA_DIAGRAM.md)

---

**โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฌุงูุฒุฉ ููุชุซุจูุช!**

**๐ ุงููุฑุญูุฉ 2 ููุชููุฉ ุจูุฌุงุญ!**

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2025-11-10  
**ุงูุฅุตุฏุงุฑ:** 1.0  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุฅูุชุงุฌ

