# ๐ง ุญู ูุดููุฉ Stored Procedures - ุฏููู ุดุงูู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูุฏููู ูุดุฑุญ ููููุฉ ุญู ูุดููุฉ ุนุฏู ูุฌูุฏ ุงูู **Stored Procedures** ูู ูุธุงู ุงูุญุณุงุจ ุงูุดุฎุตู ููููุงุทู ูุจูุฏูุฉ ุชูุฑูุช - ุนูุงุฑ.

---

## ๐จ ุงููุดููุฉ

ุนูุฏ ุชุดุบูู `setup_citizen_accounts_system.php`ุ ุชุธูุฑ ุงูุฑุณุงุฆู ุงูุชุงููุฉ:

```
โ๏ธ ุฅูุดุงุก/ุฌูุจ ุญุณุงุจ ููุงุทู (sp_get_or_create_citizen_account) ุบูุฑ ููุฌูุฏ
โ๏ธ ุชูุธูู ุงูุฑูุงุจุท ุงูููุชููุฉ (sp_cleanup_expired_links) ุบูุฑ ููุฌูุฏ
โ๏ธ ุฅุญุตุงุฆูุงุช ุงูููุงุทู (sp_get_citizen_stats) ุบูุฑ ููุฌูุฏ
```

### ๐ ุณุจุจ ุงููุดููุฉ

ุงูู Stored Procedures ูู ูุชู ุชุถููููุง ูู ููู SQL ุงูุฃุณุงุณู ุจุณุจุจ:
- ุงุณุชุฎุฏุงู `DELIMITER` ุงูุฐู ูุง ูุนูู ูุน PDO
- ุชุนููุฏ ุจููุฉ ุงูู Procedures
- ุงูุญุงุฌุฉ ููุนุงูุฌุฉ ุฎุงุตุฉ

---

## โ ุงูุญู

ุชู ุฅูุดุงุก ูููุงุช ูููุตูุฉ ุฎุงุตุฉ ุจุชุซุจูุช ุงูู Stored Procedures.

---

## ๐ ุทุฑู ุงูุชุซุจูุช

### โญ ุงูุทุฑููุฉ 1: ุงููุงุฌูุฉ ุงููุฑุฆูุฉ (ููุตู ุจูุง ูููุจุชุฏุฆูู)

1. ุงูุชุญ ุงููุชุตูุญ
2. ุงุฐูุจ ุฅูู: `http://localhost:8080/tekrit_municipality/START_HERE.html`
3. ุงุชุจุน ุงูุชุนูููุงุช ุนูู ุงูุดุงุดุฉ
4. ุงุถุบุท ุนูู ุฒุฑ "ุฅุตูุงุญ ุงูุขู"

### ๐ฏ ุงูุทุฑููุฉ 2: ุงูุฅุตูุงุญ ุงูุณุฑูุน

1. ุงูุชุญ: `http://localhost:8080/tekrit_municipality/QUICK_FIX.html`
2. ุงุถุบุท "ุฅุตูุงุญ ุงูุขู"
3. ุงูุชุธุฑ ุญุชู ุชุธูุฑ ุฑุณุงูุฉ ุงููุฌุงุญ

### ๐ง ุงูุทุฑููุฉ 3: ุงูุชุซุจูุช ุงููุจุงุดุฑ

ุงูุชุญ ูุจุงุดุฑุฉ: `http://localhost:8080/tekrit_municipality/install_stored_procedures.php`

### ๐ป ุงูุทุฑููุฉ 4: ุงุณุชุฎุฏุงู phpMyAdmin (ูููุญุชุฑููู)

1. ุงูุชุญ phpMyAdmin: `http://localhost/phpmyadmin`
2. ุงุฎุชุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช `tekrit_municipality`
3. ุงุฐูุจ ุฅูู ุชุจููุจ **SQL**
4. ุงูุชุญ ุงูููู `database/stored_procedures.sql`
5. ุงูุณุฎ ุงููุญุชูู ูุงููุงู
6. ุงูุตูู ูู phpMyAdmin
7. ุงุถุบุท **Go**

---

## ๐ ุงููููุงุช ุงููุชููุฑุฉ

### ๐จ ูููุงุช ุงููุงุฌูุฉ

| ุงูููู | ุงููุตู | ุงูุงุณุชุฎุฏุงู |
|-------|-------|-----------|
| `START_HERE.html` | ุตูุญุฉ ุงูุจุฏุงูุฉ ุงูุฑุฆูุณูุฉ | ููุทุฉ ุงูุงูุทูุงู ุงูููุตู ุจูุง |
| `QUICK_FIX.html` | ุตูุญุฉ ุงูุฅุตูุงุญ ุงูุณุฑูุน | ููุฅุตูุงุญ ุงููุจุงุดุฑ |
| `INSTALL_PROCEDURES_NOW.html` | ุตูุญุฉ ุชูุฌูู ูุดุฑุญ | ูููุฒูุฏ ูู ุงูุชูุงุตูู |

### โ๏ธ ูููุงุช ุงูุชูููุฐ

| ุงูููู | ุงููุตู |
|-------|-------|
| `install_stored_procedures.php` | ุณูุฑูุจุช PHP ุงูุชูุงุนูู |
| `database/stored_procedures.sql` | ููู SQL ููู Procedures |

### ๐ ูููุงุช ุงูุชูุซูู

| ุงูููู | ุงููุตู |
|-------|-------|
| `FIX_STORED_PROCEDURES.md` | ุฏููู ุฅุตูุงุญ ููุตู |
| `STORED_PROCEDURES_SOLUTION.txt` | ููุฎุต ุณุฑูุน |
| `README_STORED_PROCEDURES.md` | ูุฐุง ุงูููู |

---

## ๐ฏ ุงูู Stored Procedures ุงููุชููุฑุฉ

### 1๏ธโฃ `sp_get_or_create_citizen_account`

**ุงููุธููุฉ:** ุฅูุดุงุก ุญุณุงุจ ููุงุทู ุฌุฏูุฏ ุฃู ุฌูุจ ุญุณุงุจ ููุฌูุฏ

**ุงููุนุงููุงุช:**
- `p_phone` - ุฑูู ุงููุงุชู
- `p_name` - ุงุณู ุงูููุงุทู
- `p_email` - ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ุงุฎุชูุงุฑู)
- `p_national_id` - ุงูุฑูู ุงููุทูู (ุงุฎุชูุงุฑู)

**ุงูุฅุฑุฌุงุน:** `citizen_id`

**ูุซุงู:**
```sql
CALL sp_get_or_create_citizen_account(
    '03123456',
    'ูุญูุฏ ุฃุญูุฏ',
    'test@example.com',
    NULL
);
```

---

### 2๏ธโฃ `sp_cleanup_expired_links`

**ุงููุธููุฉ:** ุชูุธูู ุงูุฑูุงุจุท ุงูุณุญุฑูุฉ ูุงูุฌูุณุงุช ุงูููุชููุฉ

**ุงููุนุงููุงุช:** ูุง ููุฌุฏ

**ุงูุฅุฑุฌุงุน:**
- `deleted_magic_links` - ุนุฏุฏ ุงูุฑูุงุจุท ุงููุญุฐููุฉ
- `deleted_sessions` - ุนุฏุฏ ุงูุฌูุณุงุช ุงููุญุฐููุฉ
- `cleanup_time` - ููุช ุงูุชูุธูู

**ูุซุงู:**
```sql
CALL sp_cleanup_expired_links();
```

---

### 3๏ธโฃ `sp_get_citizen_stats`

**ุงููุธููุฉ:** ุฌูุจ ุฅุญุตุงุฆูุงุช ูุงููุฉ ุนู ุงูููุงุทู

**ุงููุนุงููุงุช:**
- `p_citizen_id` - ูุนุฑู ุงูููุงุทู

**ุงูุฅุฑุฌุงุน:** ุฌููุน ุฅุญุตุงุฆูุงุช ุงูููุงุทู (ุงูุทูุจุงุชุ ุงูุฑุณุงุฆูุ WhatsAppุ ุฅูุฎ)

**ูุซุงู:**
```sql
CALL sp_get_citizen_stats(1);
```

---

### 4๏ธโฃ `sp_create_magic_link`

**ุงููุธููุฉ:** ุฅูุดุงุก ุฑุงุจุท ุฏุฎูู ุณุญุฑู ููููุงุทู

**ุงููุนุงููุงุช:**
- `p_citizen_id` - ูุนุฑู ุงูููุงุทู
- `p_phone` - ุฑูู ุงููุงุชู
- `p_validity_hours` - ูุฏุฉ ุตูุงุญูุฉ ุงูุฑุงุจุท ุจุงูุณุงุนุงุช

**ุงูุฅุฑุฌุงุน:**
- `token` - ุงูุฑูุฒ ุงููุฑูุฏ
- `expires_at` - ุชุงุฑูุฎ ุงูุงูุชูุงุก
- `magic_link` - ุงูุฑุงุจุท ุงููุงูู

**ูุซุงู:**
```sql
CALL sp_create_magic_link(1, '03123456', 24);
```

---

### 5๏ธโฃ `sp_validate_magic_link`

**ุงููุธููุฉ:** ุงูุชุญูู ูู ุตูุงุญูุฉ ุฑุงุจุท ุงูุฏุฎูู ุงูุณุญุฑู

**ุงููุนุงููุงุช:**
- `p_token` - ุฑูุฒ ุงูุฑุงุจุท
- `p_ip_address` - ุนููุงู IP
- `p_user_agent` - ูุนูููุงุช ุงููุชุตูุญ

**ุงูุฅุฑุฌุงุน:** ูุนูููุงุช ุงูููุงุทู ุฅุฐุง ูุงู ุงูุฑุงุจุท ุตุงูุญุ ุฃู ุฎุทุฃ

**ูุซุงู:**
```sql
CALL sp_validate_magic_link(
    'abc123...',
    '192.168.1.1',
    'Mozilla/5.0...'
);
```

---

## ๐ ุงูุชุญูู ูู ุงูุชุซุจูุช

### ุงูุทุฑููุฉ 1: ุงุณุชุฎุฏุงู phpMyAdmin

1. ุงูุชุญ phpMyAdmin
2. ุงุฎุชุฑ `tekrit_municipality`
3. ุงุฐูุจ ุฅูู **Routines**
4. ูุฌุจ ุฃู ุชุฑู 5 procedures

### ุงูุทุฑููุฉ 2: ุงุณุชุฎุฏุงู SQL

```sql
SHOW PROCEDURE STATUS WHERE Db = 'tekrit_municipality';
```

### ุงูุทุฑููุฉ 3: ุฅุนุงุฏุฉ ุชุดุบูู ุตูุญุฉ ุงูุชุซุจูุช

```
http://localhost:8080/tekrit_municipality/setup_citizen_accounts_system.php
```

ูุฌุจ ุฃู ุชุฑู โ ุจุฌุงูุจ ูู procedure.

---

## ๐งช ุงุฎุชุจุงุฑ ุงูู Procedures

### ุงุฎุชุจุงุฑ ุงูุชูุธูู

```sql
CALL sp_cleanup_expired_links();
-- ุงููุชูุฌุฉ: ุนุฏุฏ ุงูุฑูุงุจุท ูุงูุฌูุณุงุช ุงููุญุฐููุฉ
```

### ุงุฎุชุจุงุฑ ุฅูุดุงุก ุญุณุงุจ

```sql
CALL sp_get_or_create_citizen_account(
    '03999888',
    'ุงุฎุชุจุงุฑ ุงูููุงุทู',
    'test@test.com',
    '12345678'
);
-- ุงููุชูุฌุฉ: citizen_id
```

### ุงุฎุชุจุงุฑ ุงูุฅุญุตุงุฆูุงุช

```sql
-- ุงุณุชุจุฏู 1 ุจูุนุฑู ููุงุทู ููุฌูุฏ
CALL sp_get_citizen_stats(1);
-- ุงููุชูุฌุฉ: ุฌููุน ุฅุญุตุงุฆูุงุช ุงูููุงุทู
```

---

## โ ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ

### ุณ: ูู ุงูุชุซุจูุช ุขููุ

โ **ูุนู 100%!** ุงูุณูุฑูุจุช:
- ูุง ูุญุฐู ุฃู ุจูุงูุงุช ููุฌูุฏุฉ
- ูุญุฐู ููุท ุงูู Procedures ุงููุฏููุฉ ุจููุณ ุงูุฃุณูุงุก
- ูุนูุฏ ุฅูุดุงุกูุง ุจุงูุฅุตุฏุงุฑ ุงูุฌุฏูุฏ

### ุณ: ูู ูุณุชุบุฑู ุงูุชุซุจูุชุ

โฑ๏ธ **ุฃูู ูู ุฏูููุฉ ูุงุญุฏุฉ** ูู ูุนุธู ุงูุญุงูุงุช.

### ุณ: ูู ูููู ุฅุนุงุฏุฉ ุงูุชุดุบููุ

โ **ูุนู!** ูููู ุชุดุบูู ุงูุณูุฑูุจุช ุนุฏุฉ ูุฑุงุช ุจุฃูุงู.

### ุณ: ูุงุฐุง ูู ูุดู ุงูุชุซุจูุชุ

๐ง **ุฌุฑุจ ุงูุญููู ุงูุชุงููุฉ:**
1. ุชุฃูุฏ ูู ุชุดุบูู XAMPP ู MySQL
2. ุชุฃูุฏ ูู ูุฌูุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช
3. ุฌุฑุจ ุงูุชุซุจูุช ุงููุฏูู ุนุจุฑ phpMyAdmin
4. ุฑุงุฌุน ุฑุณุงุฆู ุงูุฎุทุฃ ูู ุตูุญุฉ ุงูุชุซุจูุช

### ุณ: ูู ุฃุญุชุงุฌ ูุณุฎุฉ ุงุญุชูุงุทูุฉุ

๐พ **ุบูุฑ ุถุฑูุฑู** ููุฐุง ุงูุชุซุจูุชุ ููู ุฏุงุฆูุงู ููุตู ุจู ูููุงุฑุณุฉ ุฌูุฏุฉ.

---

## ๐ ุญู ุงููุดุงูู ุงูุดุงุฆุนุฉ

### ุงููุดููุฉ: ุฎุทุฃ ูู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูุญู:**
```
1. ุชุฃูุฏ ูู ุชุดุบูู XAMPP
2. ุงูุชุญ XAMPP Control Panel
3. ุชุฃูุฏ ูู ุฃู MySQL ููุฏ ุงูุชุดุบูู (ุฃุฎุถุฑ)
4. ุฃุนุฏ ุชุดุบูู ุงูุณูุฑูุจุช
```

### ุงููุดููุฉ: ุฎุทุฃ ูู ุชูููุฐ Procedure ูุนูู

**ุงูุญู:**
```
1. ุงูุชุญ database/stored_procedures.sql
2. ุงุจุญุซ ุนู ุงูู Procedure ุงูุฐู ูุดู
3. ุงูุณุฎู
4. ุฌุฑุจู ูุจุงุดุฑุฉ ูู phpMyAdmin
5. ุฑุงุฌุน ุฑุณุงูุฉ ุงูุฎุทุฃ
```

### ุงููุดููุฉ: ุงูู Procedures ููุฌูุฏุฉ ููู ูุง ุชุนูู

**ุงูุญู:**
```sql
-- ุญุฐู ุฌููุน ุงูู Procedures
DROP PROCEDURE IF EXISTS sp_get_or_create_citizen_account;
DROP PROCEDURE IF EXISTS sp_cleanup_expired_links;
DROP PROCEDURE IF EXISTS sp_get_citizen_stats;
DROP PROCEDURE IF EXISTS sp_create_magic_link;
DROP PROCEDURE IF EXISTS sp_validate_magic_link;

-- ุซู ุฃุนุฏ ุชุดุบูู ุงูุณูุฑูุจุช
```

---

## ๐ ุงูุฏุนู

### ุงูููุงุฑุฏ ุงููุชุงุญุฉ

1. **ุงูุฃุฏูุฉ:**
   - `CITIZEN_ACCOUNTS_USER_GUIDE.md` - ุฏููู ุดุงูู
   - `FIX_STORED_PROCEDURES.md` - ุฏููู ุงูุฅุตูุงุญ
   - `CITIZEN_ACCOUNTS_DATABASE_DOCUMENTATION.md` - ุชูุซูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

2. **ุงููููุงุช ุงูุชูููุฉ:**
   - `database/stored_procedures.sql` - ููุฏ SQL
   - `database/test_queries.sql` - ุงุณุชุนูุงูุงุช ุงูุงุฎุชุจุงุฑ
   - `database/QUICK_SQL_REFERENCE.sql` - ูุฑุฌุน ุณุฑูุน

3. **ุตูุญุงุช ุงูููุจ:**
   - `START_HERE.html` - ููุทุฉ ุงูุจุฏุงูุฉ
   - `QUICK_FIX.html` - ุงูุฅุตูุงุญ ุงูุณุฑูุน
   - `install_stored_procedures.php` - ุงูุชุซุจูุช ุงูุชูุงุนูู

---

## โ ุงูุฎุทูุงุช ุงูุชุงููุฉ

ุจุนุฏ ุงูุชุซุจูุช ุงููุงุฌุญ ููู Stored Procedures:

### 1. ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช WhatsApp

```
http://localhost:8080/tekrit_municipality/modules/whatsapp_settings.php
```

**ูุง ูุฌุจ ุฅุฏุฎุงูู:**
- โ ุฑูู WhatsApp Business ููุจูุฏูุฉ
- โ ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุฅุฑุณุงู (manual/api)
- โ ูุฑุงุฌุนุฉ ููุงูุจ ุงูุฑุณุงุฆู

### 2. ุงุฎุชุจุงุฑ ุงููุธุงู

```
http://localhost:8080/tekrit_municipality/public/citizen-requests.php
```

**ุฌุฑุจ:**
- โ ุชูุฏูู ุทูุจ ุฌุฏูุฏ
- โ ุชุชุจุน ุงูุทูุจ
- โ ุงุณุชูุงู ุฑุณุงูุฉ WhatsApp (ุฅุฐุง ุชู ุงูุชูุนูู)

### 3. ูุฑุงุฌุนุฉ ููุญุฉ ุงูุชุญูู

```
http://localhost:8080/tekrit_municipality/comprehensive_dashboard.php
```

**ุชุญูู ูู:**
- โ ุฅุญุตุงุฆูุงุช ุงูุทูุจุงุช
- โ ุญุณุงุจุงุช ุงูููุงุทููู
- โ ุณุฌู WhatsApp

---

## ๐ ูุนูููุงุช ุชูููุฉ

### ูุชุทูุจุงุช ุงููุธุงู

- โ PHP 7.4 ุฃู ุฃุญุฏุซ
- โ MySQL 5.7 ุฃู MariaDB 10.3 ุฃู ุฃุญุฏุซ
- โ PDO Extension
- โ XAMPP ุฃู WAMP ุฃู LAMP

### ุงูุฌุฏุงูู ุงููุณุชุฎุฏูุฉ

ุงูู Procedures ุชุชูุงุนู ูุน:
- `citizens_accounts`
- `magic_links`
- `citizen_messages`
- `whatsapp_log`
- `notification_preferences`
- `citizen_sessions`
- `citizen_requests`

### ุงูุฃูุงู

- โ ุฌููุน ุงูู Procedures ุชุณุชุฎุฏู ูุนุงููุงุช ุขููุฉ
- โ ูุง ููุฌุฏ SQL Injection
- โ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
- โ ุชุดููุฑ ุงูุฑููุฒ (SHA-256)

---

## ๐ ุณุฌู ุงูุชุบููุฑุงุช

### ุงูุฅุตุฏุงุฑ 1.0 (2025-11-11)

- โ ุฅูุดุงุก 5 Stored Procedures
- โ ุฅูุดุงุก ุณูุฑูุจุช ุงูุชุซุจูุช ุงูุชูุงุนูู
- โ ุฅูุดุงุก ุตูุญุงุช HTML ููุชูุฌูู
- โ ุฅูุดุงุก ุงูุชูุซูู ุงูุดุงูู

---

## ๐๏ธ ูุนูููุงุช ุงููุดุฑูุน

**ุงููุดุฑูุน:** ูุธุงู ุฅุฏุงุฑุฉ ุจูุฏูุฉ ุชูุฑูุช ุงูุฅููุชุฑููู  
**ุงููููุน:** ุชูุฑูุช - ุนูุงุฑุ ุดูุงู ูุจูุงู ๐ฑ๐ง  
**ุงููุณู:** ูุธุงู ุงูุญุณุงุจ ุงูุดุฎุตู ููููุงุทู  
**ุงูุชุงุฑูุฎ:** ููููุจุฑ 2025  

---

## ๐ ุงูุชุฑุฎูุต

ูุฐุง ุงููุดุฑูุน ูุฎุตุต ูุจูุฏูุฉ ุชูุฑูุช - ุนูุงุฑ.

---

## ๐ ุดูุฑ ูุชูุฏูุฑ

ุชู ุชุทููุฑ ูุฐุง ุงููุธุงู ุจูุงุณุทุฉ AI Assistant ูุฎุฏูุฉ ููุงุทูู ุจูุฏูุฉ ุชูุฑูุช.

---

**๐๏ธ ุจูุฏูุฉ ุชูุฑูุช - ุนูุงุฑุ ุดูุงู ูุจูุงู ๐ฑ๐ง**  
*ูู ุฎุฏูุฉ ุงูููุงุทู ุฏุงุฆูุงู*

