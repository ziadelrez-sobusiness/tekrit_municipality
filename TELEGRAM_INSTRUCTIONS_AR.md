# โ ูุธุงู Telegram ุฌุงูุฒ ููุนูู!

## ๐ฏ ุงููุดููุฉ ุงูุชู ุชู ุญููุง

**ุงููุดููุฉ:** ุนูุฏ ุชูุฏูู ุทูุจุ ูุง ุชุตู ุฑุณุงูุฉ ุฅูู Telegram Bot

**ุงูุณุจุจ:** ุงูููุงุทู ูู ูุจุฏุฃ ูุญุงุฏุซุฉ ูุน ุงูุจูุช ุจุนุฏุ ูุฐูู ูุง ููุฌุฏ `telegram_chat_id` ูุฅุฑุณุงู ุงูุฑุณุงูุฉ ุฅููู.

**ุงูุญู:** 
1. ุชุณุฌูู ุงูุฑุณุงูุฉ ูู "pending" (ูุนููุฉ)
2. ุฅุฑุดุงุฏ ุงูููุงุทู ููุชุญ ุงูุจูุช ูุฅุฑุณุงู ุฑูุฒ ุงูุฏุฎูู
3. ุนูุฏ ุฅุฑุณุงู ุงูุฑูุฒุ ูุชู ุฑุจุท ุงูุญุณุงุจ ูุฅุฑุณุงู ุฌููุน ุงูุฑุณุงุฆู ุงููุนููุฉ ุชููุงุฆูุงู

---

## ๐ ููู ูุนูู ุงููุธุงู ุงูุขู

### 1๏ธโฃ ุงูููุงุทู ููุฏู ุทูุจ ุฌุฏูุฏ
- ููุชุญ: `http://localhost:8080/tekrit_municipality/public/citizen-requests.php`
- ูููุฃ ุงููููุฐุฌ ููุฑุณู ุงูุทูุจ
- **ุงููุธุงู ูููู ุจู:**
  - โ ุฅูุดุงุก ุญุณุงุจ ููููุงุทู ุชููุงุฆูุงู
  - โ ุฅูุดุงุก ุฑูุฒ ุฏุฎูู ุซุงุจุช (ูุซุงู: `TKT-ABC123`)
  - โ ุชุณุฌูู ุฑุณุงูุฉ Telegram ูู "pending"
  - โณ ุงูุฑุณุงูุฉ **ูุง ุชูุฑุณู** ูุฃู ุงูููุงุทู ูู ูุดุชุฑู ูู ุงูุจูุช ุจุนุฏ

### 2๏ธโฃ ุงูููุงุทู ูุฑู ุฑุณุงูุฉ ุงููุฌุงุญ
ุจุนุฏ ุชูุฏูู ุงูุทูุจุ ูุฑู ุงูููุงุทู:

```
โ ุชู ุชูุฏูู ุทูุจูู ุจูุฌุงุญ!
๐ข ุฑูู ุงูุชุชุจุน: REQ-2025-12345

๐ ุฑูุฒ ุงูุฏุฎูู ุงูุซุงุจุช
TKT-ABC123
[๐ ูุณุฎ ุงูุฑูุฒ]

๐ฑ ุงุญุตู ุนูู ุฅุดุนุงุฑุงุช ููุฑูุฉ ุนุจุฑ Telegram

โ๏ธ ููู ุฌุฏุงู:
1๏ธโฃ ุงูุชุญ ุชุทุจูู Telegram ุนูู ูุงุชูู
2๏ธโฃ ุงุจุญุซ ุนู: @TekritAkkarBot
3๏ธโฃ ุงุถุบุท Start ูุจุฏุก ุงููุญุงุฏุซุฉ
4๏ธโฃ ุฃุฑุณู ุฑูุฒ ุงูุฏุฎูู: TKT-ABC123

[โ๏ธ ูุชุญ ุงูุจูุช ุงูุขู ูู Telegram]
```

### 3๏ธโฃ ุงูููุงุทู ููุชุญ ุงูุจูุช
- ููุชุญ Telegram
- ูุจุญุซ ุนู: `@TekritAkkarBot`
- ูุถุบุท "Start"
- **ุงูุจูุช ูุฑุณู:**

```
โ ูุฑุญุจุงู ุจู ูู ุจูุช ุจูุฏูุฉ ุชูุฑูุช - ุนูุงุฑ!

๐๏ธ ูุฐุง ุงูุจูุช ุงูุฑุณูู ูุจูุฏูุฉ ุชูุฑูุช ูู ุนูุงุฑุ ุดูุงู ูุจูุงู.

๐ฑ ุณูุชู ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ููุฑูุฉ ูู ุนูุฏ:
โข ุชูุฏูู ุทูุจ ุฌุฏูุฏ
โข ุชุญุฏูุซ ุญุงูุฉ ุทูุจู
โข ุฅูุฌุงุฒ ุทูุจู
โข ุฑุณุงุฆู ูู ุงูุจูุฏูุฉ

๐ก ูุฑุจุท ุญุณุงุจูุ ุฃุฑุณู ุฑูุฒ ุงูุฏุฎูู ุงูุฎุงุต ุจู (ูุซุงู: TKT-ABC123)
```

### 4๏ธโฃ ุงูููุงุทู ูุฑุณู ุฑูุฒ ุงูุฏุฎูู
- ุงูููุงุทู ููุชุจ: `TKT-ABC123`
- **ุงููุธุงู ูููู ุจู:**
  - โ ุงูุชุญูู ูู ุงูุฑูุฒ
  - โ ุฑุจุท `telegram_chat_id` ุจุญุณุงุจ ุงูููุงุทู
  - โ ุฅุฑุณุงู ุฑุณุงูุฉ ุชุฃููุฏ
  - โ **ุฅุฑุณุงู ุฌููุน ุงูุฑุณุงุฆู ุงููุนููุฉ (pending) ุชููุงุฆูุงู**

### 5๏ธโฃ ุงูููุงุทู ูุณุชูู ุงูุฅุดุนุงุฑุงุช
ููุฑุงู ุจุนุฏ ุฑุจุท ุงูุญุณุงุจุ ูุณุชูู ุงูููุงุทู:

```
โ ุชู ุฑุจุท ุญุณุงุจู ุจูุฌุงุญ!

๐ค ุงูุงุณู: ุฒูุงุฏ ุงูุฑุฒ
๐ฑ ุงููุงุชู: 03670065

๐ ุณุชุณุชูู ุงูุขู ุฌููุน ุงูุฅุดุนุงุฑุงุช ุงููุชุนููุฉ ุจุทูุจุงุชู.

[๐ค ุญุณุงุจู ุงูุดุฎุตู] [๐ ุชูุฏูู ุทูุจ]
```

ุซู:

```
โ ุชู ุชูุฏูู ุทูุจูู ุจูุฌุงุญ!

๐ข ุฑูู ุงูุชุชุจุน: REQ-2025-12345
๐ ููุน ุงูุทูุจ: ุฅูุงุฏุฉ ุณูู
๐ ุงูุชุงุฑูุฎ: 2025-11-12

๐ ุฑูุฒ ุงูุฏุฎูู ุงูุซุงุจุช: TKT-ABC123

[๐ ุชุชุจุน ุงูุทูุจ] [๐ค ุญุณุงุจู]
```

ุซู:

```
๐ฌ ุชู ุฅุฑุณุงู 1 ุฅุดุนุงุฑ(ุงุช) ูุนููุฉ.

โ ุฃูุช ุงูุขู ูุดุชุฑู ูู ุงูุฅุดุนุงุฑุงุช ุงูููุฑูุฉ!
```

---

## ๐ ุงูุชุญุฏูุซุงุช ุงููุณุชูุจููุฉ

ุจุนุฏ ุฑุจุท ุงูุญุณุงุจุ ุณูุณุชูู ุงูููุงุทู ุฅุดุนุงุฑุงุช ููุฑูุฉ ุนูุฏ:

- ๐ ุชูุฏูู ุทูุจ ุฌุฏูุฏ
- ๐ ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ
- โ ุฅูุฌุงุฒ ุงูุทูุจ
- ๐ฌ ุฑุณุงุฆู ูู ุงูุจูุฏูุฉ

---

## ๐ง ุงูุฅุตูุงุญุงุช ุงูุชู ุชูุช

### 1. ุชุญุณูู ุฑุณุงูุฉ ุงููุฌุงุญ (`public/citizen-requests.php`)
- โ ุฅุถุงูุฉ ุชุนูููุงุช ูุงุถุญุฉ ุฎุทูุฉ ุจุฎุทูุฉ
- โ ุฅุถุงูุฉ ุฒุฑ ูุจุงุดุฑ ููุชุญ ุงูุจูุช ูู Telegram
- โ ุชุญุณูู ุงูุชูุณูู ูุงูุฃููุงู

### 2. ุฅุฑุณุงู ุงูุฑุณุงุฆู ุงููุนููุฉ ุชููุงุฆูุงู (`public/telegram_webhook.php`)
- โ ุฅุถุงูุฉ ุฏุงูุฉ `sendPendingMessages()`
- โ ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ุนูุฏ ุฑุจุท ุงูุญุณุงุจ (ุฑูุฒ ุฏุฎูู ุฃู ุฑูู ูุงุชู)
- โ ุฅุฑุณุงู ุฑุณุงูุฉ ููุฎุต ุจุนุฏ ุฅุฑุณุงู ุงูุฑุณุงุฆู ุงููุนููุฉ

---

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### ุงูุฎุทูุงุช:

1. **ูุฏู ุทูุจ ุฌุฏูุฏ**
   ```
   http://localhost:8080/tekrit_municipality/public/citizen-requests.php
   ```

2. **ุงุญูุธ ุฑูุฒ ุงูุฏุฎูู**
   - ุจุนุฏ ุชูุฏูู ุงูุทูุจุ ุงูุณุฎ ุฑูุฒ ุงูุฏุฎูู (ูุซุงู: `TKT-ABC123`)

3. **ุงูุชุญ ุงูุจูุช**
   - ุงูุชุญ Telegram
   - ุงุจุญุซ ุนู: `@TekritAkkarBot`

4. **ุงุถุบุท Start**
   - ุงุถุบุท ุฒุฑ "Start" ูุจุฏุก ุงููุญุงุฏุซุฉ

5. **ุฃุฑุณู ุฑูุฒ ุงูุฏุฎูู**
   - ุงูุชุจ: `TKT-ABC123`
   - ุฃุฑุณู ุงูุฑุณุงูุฉ

6. **ุงุณุชูู ุงูุฅุดุนุงุฑุงุช**
   - ูุฌุจ ุฃู ุชุณุชูู ููุฑุงู:
     - ุฑุณุงูุฉ ุชุฃููุฏ ุงูุฑุจุท
     - ุงูุฅุดุนุงุฑ ุงููุนูู ุนู ุงูุทูุจ
     - ุฑุณุงูุฉ ููุฎุต

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### 1. `public/citizen-requests.php`
**ุงูุชุนุฏููุงุช:**
- ุชุญุณูู ุฑุณุงูุฉ ุงููุฌุงุญ
- ุฅุถุงูุฉ ุชุนูููุงุช ูุงุถุญุฉ ููุชุญ ุงูุจูุช
- ุฅุถุงูุฉ ุฒุฑ ูุจุงุดุฑ: `https://t.me/TekritAkkarBot`

### 2. `public/telegram_webhook.php`
**ุงูุชุนุฏููุงุช:**
- ุฅุถุงูุฉ ุฏุงูุฉ `sendPendingMessages($db, $botToken, $citizenId, $chatId)`
- ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ูู ุญุงูุชูู:
  - ุนูุฏ ุฅุฑุณุงู ุฑูุฒ ุงูุฏุฎูู
  - ุนูุฏ ุฅุฑุณุงู ุฑูู ุงููุงุชู

**ููุฏ ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ:**
```php
function sendPendingMessages($db, $botToken, $citizenId, $chatId) {
    try {
        // ุฌูุจ ุฌููุน ุงูุฑุณุงุฆู ุงููุนููุฉ
        $stmt = $db->prepare("
            SELECT * FROM telegram_log 
            WHERE citizen_id = ? 
            AND status = 'pending' 
            ORDER BY created_at ASC
        ");
        $stmt->execute([$citizenId]);
        $pendingMessages = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        if (empty($pendingMessages)) {
            return;
        }
        
        // ุฅุฑุณุงู ูู ุฑุณุงูุฉ ูุนููุฉ
        foreach ($pendingMessages as $msg) {
            $sent = sendTelegramMessage($botToken, $chatId, $msg['message_text']);
            
            if ($sent) {
                // ุชุญุฏูุซ ุญุงูุฉ ุงูุฑุณุงูุฉ ุฅูู "sent"
                $updateStmt = $db->prepare("
                    UPDATE telegram_log 
                    SET status = 'sent', 
                        sent_at = NOW(),
                        updated_at = NOW()
                    WHERE id = ?
                ");
                $updateStmt->execute([$msg['id']]);
            }
            
            // ุชุฃุฎูุฑ ุจุณูุท ูุชุฌูุจ ุงูุญุธุฑ ูู Telegram
            usleep(500000); // 0.5 ุซุงููุฉ
        }
        
        // ุฅุฑุณุงู ุฑุณุงูุฉ ุฅุถุงููุฉ ูุฅุนูุงู ุงูููุงุทู
        if (count($pendingMessages) > 0) {
            $summaryMessage = "๐ฌ ุชู ุฅุฑุณุงู " . count($pendingMessages) . " ุฅุดุนุงุฑ(ุงุช) ูุนููุฉ.\n\n";
            $summaryMessage .= "โ ุฃูุช ุงูุขู ูุดุชุฑู ูู ุงูุฅุดุนุงุฑุงุช ุงูููุฑูุฉ!";
            sendTelegramMessage($botToken, $chatId, $summaryMessage);
        }
        
    } catch (Exception $e) {
        error_log("Send Pending Messages Error: " . $e->getMessage());
    }
}
```

---

## ๐ ุฌุฏูู telegram_log

ุงูุฑุณุงุฆู ูุชู ุชุณุฌูููุง ูู ุฌุฏูู `telegram_log` ุจุซูุงุซ ุญุงูุงุช:

| ุงูุญุงูุฉ | ุงููุตู |
|--------|-------|
| `pending` | ุงูุฑุณุงูุฉ ูุนููุฉ - ุงูููุงุทู ูู ูุดุชุฑู ูู ุงูุจูุช ุจุนุฏ |
| `sent` | ุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุจูุฌุงุญ |
| `failed` | ูุดู ุฅุฑุณุงู ุงูุฑุณุงูุฉ |

---

## โ ุงููุธุงู ุฌุงูุฒ!

ุงูุขู ุนูุฏ ุชูุฏูู ุทูุจ:
1. โ ูุชู ุชุณุฌูู ุงูุฑุณุงูุฉ ูู "pending"
2. โ ูุฑู ุงูููุงุทู ุชุนูููุงุช ูุงุถุญุฉ
3. โ ุนูุฏ ูุชุญ ุงูุจูุช ูุฅุฑุณุงู ุงูุฑูุฒุ ุชูุฑุณู ุฌููุน ุงูุฑุณุงุฆู ุงููุนููุฉ ุชููุงุฆูุงู
4. โ ุงูููุงุทู ูุณุชูู ุฅุดุนุงุฑุงุช ููุฑูุฉ ูุฌููุน ุงูุชุญุฏูุซุงุช ุงููุณุชูุจููุฉ

---

## ๐ ุฌุฑุจ ุงูุขู!

ุงูุชุญ:
```
http://localhost:8080/tekrit_municipality/TELEGRAM_SYSTEM_READY.html
```

ููุญุตูู ุนูู ุดุฑุญ ููุตู ุจุงูุตูุฑ ูุงูุฃููุงู!

---

**๐๏ธ ุจูุฏูุฉ ุชูุฑูุช - ุนูุงุฑุ ุดูุงู ูุจูุงู ๐ฑ๐ง**

