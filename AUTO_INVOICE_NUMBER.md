# ✅ ترقيم تلقائي للفواتير

## 🎯 الميزة الجديدة:

عند إنشاء فاتورة جديدة، يتم توليد رقم الفاتورة **تلقائياً** بالصيغة:

```
INV-YYYY-XXX
```

حيث:
- `INV` = اختصار Invoice (فاتورة)
- `YYYY` = السنة الحالية (2025, 2026, ...)
- `XXX` = رقم تسلسلي من 001 إلى 999

---

## 📋 أمثلة:

### السنة 2025:
```
INV-2025-001  ← الفاتورة الأولى
INV-2025-002  ← الفاتورة الثانية
INV-2025-003  ← الفاتورة الثالثة
...
INV-2025-999  ← الفاتورة 999
```

### عند تغيير السنة إلى 2026:
```
INV-2026-001  ← يبدأ من جديد تلقائياً!
INV-2026-002
INV-2026-003
...
```

---

## 🔧 كيف يعمل:

### 1. **عند فتح نموذج إضافة فاتورة:**
```php
// النظام يبحث عن آخر رقم فاتورة للسنة الحالية
SELECT invoice_number 
FROM supplier_invoices 
WHERE invoice_number LIKE 'INV-2025-%' 
ORDER BY id DESC 
LIMIT 1;

// إذا كان آخر رقم: INV-2025-005
// الرقم التالي: INV-2025-006
```

### 2. **في بداية سنة جديدة:**
```php
// في 2026-01-01
// لا توجد فواتير بـ INV-2026-%
// يبدأ من: INV-2026-001
```

### 3. **عرض الرقم في الحقل:**
```
┌──────────────────────────────┐
│ رقم الفاتورة *              │
├──────────────────────────────┤
│ INV-2025-006                 │  ← تلقائي!
│                              │  (قراءة فقط)
└──────────────────────────────┘
```

---

## ✨ الميزات:

### 1. **تلقائي بالكامل** 🤖
```
✅ لا حاجة لإدخال الرقم يدوياً
✅ لا تكرار في الأرقام
✅ تسلسل صحيح دائماً
```

### 2. **يتغير مع السنة** 📅
```
✅ 2025 → INV-2025-XXX
✅ 2026 → INV-2026-XXX (يبدأ من 001)
✅ 2027 → INV-2027-XXX (يبدأ من 001)
```

### 3. **قابل للتعديل عند الحاجة** ✏️
```
الحقل محمي (readonly)
لكن يمكن تعديله بـ:
- النقر المزدوج على الحقل
- أو تفعيل التحرير من المتصفح
```

### 4. **واضح وموحد** 📊
```
جميع الفواتير بنفس النمط:
INV-YYYY-XXX
```

---

## 🎮 طريقة الاستخدام:

### **خطوة 1: افتح صفحة الفواتير**
```
http://localhost:8080/tekrit_municipality/modules/invoices.php
```

### **خطوة 2: اضغط "➕ إضافة فاتورة جديدة"**

### **خطوة 3: لاحظ حقل رقم الفاتورة**
```
┌──────────────────────────────┐
│ رقم الفاتورة *              │
├──────────────────────────────┤
│ INV-2025-007                 │  ← معبأ تلقائياً!
│ (خلفية زرقاء فاتحة)         │  ← دليل أنه تلقائي
└──────────────────────────────┘

💡 الرقم محمي من التعديل (readonly)
```

### **خطوة 4: أكمل باقي البيانات**
```
- المورد
- التاريخ
- المبلغ
- إلخ...
```

### **خطوة 5: احفظ**
```
✅ يتم حفظ الفاتورة بالرقم التلقائي
✅ الفاتورة التالية ستأخذ الرقم التالي
```

---

## 🔄 أمثلة عملية:

### **المثال 1: إضافة 3 فواتير**
```
فاتورة 1:
- رقم تلقائي: INV-2025-001
- المورد: شركة ABC
- احفظ ✅

فاتورة 2:
- رقم تلقائي: INV-2025-002  ← زاد تلقائياً!
- المورد: شركة XYZ
- احفظ ✅

فاتورة 3:
- رقم تلقائي: INV-2025-003  ← زاد تلقائياً!
- المورد: مورد آخر
- احفظ ✅
```

### **المثال 2: في بداية سنة جديدة**
```
📅 اليوم: 2025-12-31
- آخر فاتورة: INV-2025-156

📅 اليوم: 2026-01-01
- فاتورة جديدة: INV-2026-001  ← بدأ من جديد!
```

### **المثال 3: حذف فاتورة**
```
الفواتير الحالية:
- INV-2025-005
- INV-2025-006
- INV-2025-007

حذف INV-2025-006 ❌

الفاتورة الجديدة:
- INV-2025-008  ← يستمر التسلسل (لا يعيد استخدام 006)
```

---

## ⚙️ التخصيص (إذا أردت):

### **تغيير البادئة من INV إلى شيء آخر:**
```php
// في modules/invoices.php - سطر 307
return sprintf("INV-%s-%03d", $current_year, $new_number);

// غيّرها إلى:
return sprintf("FAT-%s-%03d", $current_year, $new_number);
// النتيجة: FAT-2025-001, FAT-2025-002, ...
```

### **تغيير عدد الأرقام:**
```php
// 3 أرقام (001-999):
sprintf("INV-%s-%03d", $current_year, $new_number)

// 4 أرقام (0001-9999):
sprintf("INV-%s-%04d", $current_year, $new_number)

// 5 أرقام (00001-99999):
sprintf("INV-%s-%05d", $current_year, $new_number)
```

### **إضافة اختصار الشهر:**
```php
$current_year = date('Y');
$current_month = date('m');
return sprintf("INV-%s-%s-%03d", $current_year, $current_month, $new_number);
// النتيجة: INV-2025-01-001, INV-2025-02-001, ...
```

---

## 🔒 الحماية:

### **الحقل محمي (readonly):**
```html
<input type="text" 
       name="invoice_number" 
       value="INV-2025-007"
       readonly  ← لا يمكن تعديله عادياً
       class="bg-blue-50"  ← خلفية زرقاء للتوضيح
>
```

### **لكن يمكن فك الحماية:**
```javascript
ondblclick="
  this.removeAttribute('readonly');  // إزالة القفل
  this.classList.remove('bg-blue-50'); // إزالة الخلفية الزرقاء
"
```

### **لماذا هذا التصميم؟**
```
✅ الحماية: تمنع التعديل الخاطئ
✅ المرونة: يمكن التعديل عند الحاجة (نقر مزدوج)
✅ الوضوح: الخلفية الزرقاء تدل أنه تلقائي
```

---

## 🧪 الاختبار:

### **اختبار 1: الترقيم التسلسلي**
```
1. أضف فاتورة → الرقم: INV-2025-001 ✅
2. أضف فاتورة → الرقم: INV-2025-002 ✅
3. أضف فاتورة → الرقم: INV-2025-003 ✅
```

### **اختبار 2: تغيير السنة**
```
1. غيّر تاريخ النظام إلى 2026
2. أضف فاتورة → الرقم: INV-2026-001 ✅
```

### **اختبار 3: عدم التكرار**
```
1. أضف 10 فواتير
2. تحقق: لا يوجد رقم مكرر ✅
```

---

## ❓ الأسئلة الشائعة:

### **س: ماذا لو أردت تعديل الرقم؟**
```
ج: انقر مزدوجاً على الحقل ← سيصبح قابلاً للتعديل
```

### **س: ماذا لو حذفت فاتورة؟**
```
ج: الرقم لا يُعاد استخدامه
   مثال: حذف INV-2025-005
   الفاتورة التالية: INV-2025-006 (ليس 005)
```

### **س: ماذا لو وصلت إلى 999؟**
```
ج: يمكن تغيير التنسيق إلى 4 أرقام (0001-9999)
   أو استخدام شهر/سنة مختلف
```

### **س: هل يعمل مع فواتير يدوية قديمة؟**
```
ج: نعم! يبحث عن آخر رقم موجود ويتابع منه
```

---

## 🎯 الفوائد:

### ✅ **توفير الوقت:**
```
قبل: إدخال الرقم يدوياً في كل مرة
الآن: تلقائي بالكامل
```

### ✅ **منع الأخطاء:**
```
قبل: خطر تكرار الأرقام
الآن: مستحيل التكرار
```

### ✅ **التنظيم:**
```
قبل: أرقام عشوائية
الآن: تسلسل واضح ومنظم
```

### ✅ **الاحترافية:**
```
النمط الموحد: INV-YYYY-XXX
يعطي انطباعاً احترافياً
```

---

## 📊 الخلاصة:

### **ما تم إضافته:**
```php
function generateInvoiceNumber($db) {
    // 1. جلب السنة الحالية
    // 2. البحث عن آخر رقم فاتورة
    // 3. زيادة الرقم بواحد
    // 4. إرجاع: INV-YYYY-XXX
}
```

### **كيف يظهر:**
```
┌────────────────────────────────────┐
│ ➕ إضافة فاتورة جديدة             │
├────────────────────────────────────┤
│ رقم الفاتورة *                    │
│ ┌──────────────────────────────┐  │
│ │ INV-2025-008                 │  │ ← تلقائي!
│ └──────────────────────────────┘  │
│                                    │
│ المورد *                           │
│ [...اختر المورد...]              │
│                                    │
│ تاريخ الفاتورة *                  │
│ [2025-11-03]                      │
│                                    │
│ ...                                │
└────────────────────────────────────┘
```

---

**🎉 الآن كل فاتورة تحصل على رقم تلقائي فريد ومنظم!**

جرّب الآن: `http://localhost:8080/tekrit_municipality/modules/invoices.php`


